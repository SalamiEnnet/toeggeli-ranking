<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Töggeli Rangliste</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background:#f6f7f9; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border-radius: 14px; padding: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.06); margin-bottom: 14px; }
    h1 { font-size: 18px; margin: 0 0 10px; }
    .grid { display: grid; gap: 10px; }
    @media (min-width: 900px){ .grid-2 { grid-template-columns: 1fr 1fr; } }
    label { font-size: 12px; color:#444; display:block; margin-bottom: 4px; }
    input { width: 100%; padding: 12px; border:1px solid #ddd; border-radius: 10px; font-size: 16px; }
    button { width:100%; padding: 12px; border:0; border-radius: 10px; font-size: 16px; background:#111; color:#fff; cursor:pointer; }
    button.secondary { background:#fff; color:#111; border:1px solid #ddd; }
    button:disabled { opacity: .5; cursor:not-allowed; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom:1px solid #eee; text-align:left; font-size: 14px; }
    th { cursor: pointer; user-select:none; white-space:nowrap; }
    .muted { color:#666; font-size: 12px; }
    .row { display:flex; gap:10px; align-items: end; }
    .row > div { flex: 1; }
    .suggest { position:relative; }
    .suggest-list { position:absolute; left:0; right:0; top: 74px; background:#fff; border:1px solid #ddd; border-radius: 10px; max-height: 220px; overflow:auto; z-index: 9; }
    .suggest-item { padding: 10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; gap:10px; }
    .suggest-item:last-child { border-bottom:0; }
    .suggest-item:hover { background:#f3f4f6; cursor:pointer; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#f1f1f1; font-size:12px; }
    .ok { color:#0a7a2f; }
    .bad { color:#b00020; }
  </style>
</head>
<body>
<div class="wrap">

  <!-- Spieler registrieren -->
  <div class="card">
    <h1>Neuen Spieler anmelden</h1>
    <div class="row">
      <div>
        <label>Spielername</label>
        <input id="new_player" placeholder="z. B. Nina Meier" autocomplete="off" />
        <div class="muted" id="new_player_hint" style="margin-top:6px"></div>
      </div>
      <div style="flex:0.7">
        <button id="btn_register" class="secondary">Spieler registrieren</button>
      </div>
    </div>
    <div class="muted" id="register_status" style="margin-top:8px"></div>
  </div>

  <!-- Spiel eintragen -->
  <div class="card">
    <h1>Spiel eintragen (2 vs. 2)</h1>
    <div class="muted">Du musst jeden Spieler aus der Liste anklicken (nur registrierte Spieler).</div>

    <div class="grid grid-2" style="margin-top:10px">
      <div>
        <div class="row">
          <div class="suggest">
            <label>Team 1 – Spieler A</label>
            <input id="p1" placeholder="Name tippen…" autocomplete="off" />
            <div class="suggest-list" id="p1_s" style="display:none"></div>
            <div class="muted" id="p1_ok" style="margin-top:6px"></div>
          </div>
          <div class="suggest">
            <label>Team 1 – Spieler B</label>
            <input id="p2" placeholder="Name tippen…" autocomplete="off" />
            <div class="suggest-list" id="p2_s" style="display:none"></div>
            <div class="muted" id="p2_ok" style="margin-top:6px"></div>
          </div>
        </div>
      </div>
      <div>
        <div class="row">
          <div class="suggest">
            <label>Team 2 – Spieler C</label>
            <input id="p3" placeholder="Name tippen…" autocomplete="off" />
            <div class="suggest-list" id="p3_s" style="display:none"></div>
            <div class="muted" id="p3_ok" style="margin-top:6px"></div>
          </div>
          <div class="suggest">
            <label>Team 2 – Spieler D</label>
            <input id="p4" placeholder="Name tippen…" autocomplete="off" />
            <div class="suggest-list" id="p4_s" style="display:none"></div>
            <div class="muted" id="p4_ok" style="margin-top:6px"></div>
          </div>
        </div>
      </div>
    </div>

    <div style="height:10px"></div>

    <div class="row">
      <div>
        <label>Resultat Team 1</label>
        <input id="g1" type="number" min="0" placeholder="z. B. 10" />
      </div>
      <div>
        <label>Resultat Team 2</label>
        <input id="g2" type="number" min="0" placeholder="z. B. 7" />
      </div>
    </div>

    <div style="height:10px"></div>
    <button id="submit">Spiel speichern</button>
    <div class="muted" id="status" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <h1>Live-Rangliste</h1>
    <div class="muted">Tippe auf Spaltenköpfe zum Sortieren.</div>
    <div style="overflow:auto; margin-top:10px">
      <table id="tbl">
        <thead>
          <tr>
            <th data-k="name">Name</th>
            <th data-k="games">Spiele</th>
            <th data-k="wins">Gewonnen</th>
            <th data-k="win_pct">Gewonnen %</th>
            <th data-k="goals_for">Tore</th>
            <th data-k="goals_against">Gegentore</th>
            <th data-k="elo">ELO</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h1>Monatsrückblick (aktueller Monat)</h1>
    <div class="muted">Unabhängig vom Gesamt-ELO – nur Spiele im aktuellen Monat.</div>
    <div id="monthStats" style="margin-top:10px"></div>
  </div>
</div>

<script>
  const SUPABASE_URL = "https://upiezncrabetmffxhloq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwaWV6bmNyYWJldG1mZnhobG9xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNzAxMjAsImV4cCI6MjA4NTk0NjEyMH0.CVYIaX9nF15uXjFsWvysBNW56eKaex9dk4Vot-1hDLY";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const els = {
    // register
    newPlayer: document.getElementById('new_player'),
    newPlayerHint: document.getElementById('new_player_hint'),
    btnRegister: document.getElementById('btn_register'),
    registerStatus: document.getElementById('register_status'),

    // match
    p1: document.getElementById('p1'), p2: document.getElementById('p2'),
    p3: document.getElementById('p3'), p4: document.getElementById('p4'),
    p1ok: document.getElementById('p1_ok'),
    p2ok: document.getElementById('p2_ok'),
    p3ok: document.getElementById('p3_ok'),
    p4ok: document.getElementById('p4_ok'),

    g1: document.getElementById('g1'), g2: document.getElementById('g2'),
    submit: document.getElementById('submit'),
    status: document.getElementById('status'),
  };

  let players = [];
  let sortKey = 'elo';
  let sortDir = 'desc';

  // Pro Input merken wir uns: welcher Spieler wurde wirklich angeklickt?
  const selected = new Map(); // key: inputId -> { id, name }

  function normName(s){ return (s || '').trim(); }
  function canon(s){ return normName(s).toLowerCase(); }
  function setStatus(msg){ els.status.textContent = msg || ''; }
  function setRegisterStatus(msg){ els.registerStatus.textContent = msg || ''; }

  function setPickHint(inputId, okEl, value){
    if (value && value.id){
      okEl.innerHTML = `<span class="ok">✓ ausgewählt: ${value.name}</span>`;
    } else {
      okEl.innerHTML = `<span class="bad">✕ bitte aus Liste auswählen</span>`;
    }
  }

  async function loadPlayers(){
  // 1) Spieler laden
  const { data: pData, error: pErr } = await sb.from('players').select('id,name');
  if (pErr) { setStatus("Fehler beim Laden der Spieler: " + pErr.message); return; }

  // 2) Matches laden
  const { data: mData, error: mErr } = await sb.from('matches').select('*');
  if (mErr) { setStatus("Fehler beim Laden der Spiele: " + mErr.message); return; }

  const pMap = new Map((pData || []).map(p => [p.id, p]));

  // Stats initialisieren
  const stat = new Map();
  function ensure(pid){
    if (!stat.has(pid)){
      const p = pMap.get(pid);
      stat.set(pid, {
        id: pid,
        name: p ? p.name : ("#" + pid),
        games: 0,
        wins: 0,
        goals_for: 0,
        goals_against: 0,
        elo: 1000 // Startwert (falls du ELO später noch richtig rechnen willst)
      });
    }
    return stat.get(pid);
  }

  // Matches aggregieren
  for (const m of (mData || [])){
    const t1g = Number(m.team1_goals) || 0;
    const t2g = Number(m.team2_goals) || 0;
    const t1w = t1g > t2g ? 1 : 0;
    const t2w = t2g > t1g ? 1 : 0;

    const team1 = [m.p1_id, m.p2_id];
    const team2 = [m.p3_id, m.p4_id];

    for (const pid of team1){
      const s = ensure(pid);
      s.games += 1;
      s.wins += t1w;
      s.goals_for += t1g;
      s.goals_against += t2g;
    }
    for (const pid of team2){
      const s = ensure(pid);
      s.games += 1;
      s.wins += t2w;
      s.goals_for += t2g;
      s.goals_against += t1g;
    }
  }

  // Ausgabeformat wie vorher
  players = [...stat.values()].map(p => ({
    ...p,
    win_pct: p.games > 0 ? Math.round((p.wins / p.games) * 1000) / 10 : 0,
    elo: Math.round(Number(p.elo) * 10) / 10
  }));

  renderTable();
}


    // Register-Hint aktualisieren
    const typed = canon(els.newPlayer.value);
    if (!typed) els.newPlayerHint.textContent = '';
    else {
      const exists = players.some(p => canon(p.name) === typed);
      els.newPlayerHint.textContent = exists ? "Dieser Name ist bereits registriert." : "Noch nicht registriert.";
    }

    renderTable();
  }

  function sortPlayers(list){
    const dir = sortDir === 'asc' ? 1 : -1;
    return [...list].sort((a,b)=>{
      const va = a[sortKey], vb = b[sortKey];
      if (typeof va === 'string') return va.localeCompare(vb) * dir;
      return (Number(va) - Number(vb)) * dir;
    });
  }

  function renderTable(){
    const tbody = document.querySelector('#tbl tbody');
    tbody.innerHTML = '';
    const rows = sortPlayers(players);
    for (const p of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.name}</td>
        <td>${p.games}</td>
        <td>${p.wins}</td>
        <td>${p.win_pct}%</td>
        <td>${p.goals_for}</td>
        <td>${p.goals_against}</td>
        <td><span class="pill">${p.elo}</span></td>
      `;
      tbody.appendChild(tr);
    }
  }

  function invalidateSelection(inputEl, okEl){
    selected.delete(inputEl.id);
    setPickHint(inputEl.id, okEl, null);
  }

  function attachSuggestStrict(inputEl, listEl, okEl){
    // Wenn User tippt: Auswahl wird ungültig, bis er wieder klickt.
    inputEl.addEventListener('input', ()=>{
      invalidateSelection(inputEl, okEl);

      const q = canon(inputEl.value);
      if (!q){ listEl.style.display='none'; listEl.innerHTML=''; return; }

      const matches = players
        .filter(p => canon(p.name).includes(q))
        .sort((a,b)=> a.name.localeCompare(b.name))
        .slice(0, 10);

      listEl.innerHTML = '';
      for (const m of matches){
        const div = document.createElement('div');
        div.className = 'suggest-item';
        div.innerHTML = `<span>${m.name}</span><span class="pill">Tippen</span>`;
        div.onmousedown = (ev)=>{ ev.preventDefault(); }; // verhindert blur beim klicken
        div.onclick = ()=>{
          inputEl.value = m.name;
          selected.set(inputEl.id, { id: m.id, name: m.name });
          listEl.style.display='none';
          setPickHint(inputEl.id, okEl, selected.get(inputEl.id));
        };
        listEl.appendChild(div);
      }
      listEl.style.display = matches.length ? 'block' : 'none';
    });

    inputEl.addEventListener('blur', ()=> setTimeout(()=>{ listEl.style.display='none'; }, 150));
    inputEl.addEventListener('focus', ()=> inputEl.dispatchEvent(new Event('input')));

    // Initial hint
    setPickHint(inputEl.id, okEl, null);
  }

  attachSuggestStrict(els.p1, document.getElementById('p1_s'), els.p1ok);
  attachSuggestStrict(els.p2, document.getElementById('p2_s'), els.p2ok);
  attachSuggestStrict(els.p3, document.getElementById('p3_s'), els.p3ok);
  attachSuggestStrict(els.p4, document.getElementById('p4_s'), els.p4ok);

  // Spieler registrieren: nur wenn noch nicht vorhanden
  async function registerPlayer(){
    try{
      els.btnRegister.disabled = true;
      setRegisterStatus("Speichern…");

      const name = normName(els.newPlayer.value);
      if (!name) throw new Error("Bitte einen Spielernamen eingeben.");

      const exists = players.some(p => canon(p.name) === canon(name));
      if (exists) throw new Error("Dieser Spieler ist bereits registriert.");

      const { error } = await sb.from('players').insert([{ name }]);
      if (error) throw error;

      els.newPlayer.value = '';
      els.newPlayerHint.textContent = '';
      setRegisterStatus("✅ Spieler registriert.");
      await loadPlayers();
    } catch(e){
      setRegisterStatus("❌ " + (e.message || String(e)));
    } finally {
      els.btnRegister.disabled = false;
    }
  }

  els.btnRegister.addEventListener('click', registerPlayer);
  els.newPlayer.addEventListener('input', ()=>{
    const typed = canon(els.newPlayer.value);
    if (!typed){ els.newPlayerHint.textContent = ''; return; }
    const exists = players.some(p => canon(p.name) === typed);
    els.newPlayerHint.textContent = exists ? "Dieser Name ist bereits registriert." : "Noch nicht registriert.";
  });

  async function submitMatch(){
    try{
      els.submit.disabled = true;
      setStatus("Speichern…");

      // Strikte Auswahl: es muss pro Feld ein selected-Eintrag existieren
      const pickIds = ['p1','p2','p3','p4'].map(id => selected.get(id));
      if (pickIds.some(x => !x || !x.id)) throw new Error("Bitte alle 4 Spieler aus der Liste auswählen (anklicken).");

      // Keine Doppelten
      const ids = pickIds.map(x=>x.id);
      if ((new Set(ids)).size !== 4) throw new Error("Ein Spieler darf im gleichen Match nicht doppelt vorkommen.");

      const g1 = Number(els.g1.value), g2 = Number(els.g2.value);
      if (!Number.isFinite(g1) || !Number.isFinite(g2) || g1 < 0 || g2 < 0) {
        throw new Error("Bitte ein gültiges Resultat eingeben (>= 0).");
      }

      const [p1_id, p2_id, p3_id, p4_id] = ids;

      const { error } = await sb.from('matches').insert([{
        p1_id, p2_id, p3_id, p4_id,
        team1_goals: g1,
        team2_goals: g2
      }]);
      if (error) throw error;

      // Reset
      els.g1.value = ''; els.g2.value = '';
      ['p1','p2','p3','p4'].forEach(id=>{
        document.getElementById(id).value = '';
        selected.delete(id);
      });
      setPickHint('p1', els.p1ok, null);
      setPickHint('p2', els.p2ok, null);
      setPickHint('p3', els.p3ok, null);
      setPickHint('p4', els.p4ok, null);

      setStatus("✅ Gespeichert. Rangliste aktualisiert sich gleich.");
      await loadPlayers();
      await loadMonthStats();
    } catch(e){
      setStatus("❌ " + (e.message || String(e)));
    } finally {
      els.submit.disabled = false;
    }
  }

  els.submit.addEventListener('click', submitMatch);

  document.querySelectorAll('#tbl thead th').forEach(th=>{
    th.addEventListener('click', ()=>{
      const k = th.dataset.k;
      if (!k) return;
      if (sortKey === k) sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
      else { sortKey = k; sortDir = (k === 'name') ? 'asc' : 'desc'; }
      renderTable();
    });
  });

  async function loadMonthStats(){
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), 1);
    const end = new Date(now.getFullYear(), now.getMonth() + 1, 1);

    const { data, error } = await sb.from('matches').select('*')
      .gte('created_at', start.toISOString())
      .lt('created_at', end.toISOString());

    const box = document.getElementById('monthStats');
    if (error) { box.textContent = "Fehler: " + error.message; return; }

    const matches = data || [];
    const stat = new Map();

    function add(pid, games, wins, goals){
      const s = stat.get(pid) || { games:0, wins:0, goals:0 };
      s.games += games; s.wins += wins; s.goals += goals;
      stat.set(pid, s);
    }

    for (const m of matches){
      const t1w = m.team1_goals > m.team2_goals ? 1 : 0;
      const t2w = m.team2_goals > m.team1_goals ? 1 : 0;
      add(m.p1_id, 1, t1w, m.team1_goals);
      add(m.p2_id, 1, t1w, m.team1_goals);
      add(m.p3_id, 1, t2w, m.team2_goals);
      add(m.p4_id, 1, t2w, m.team2_goals);
    }

    const asRows = [...stat.entries()].map(([pid, s])=>{
      const p = players.find(x=>x.id===pid);
      return { name: p ? p.name : ("#" + pid), ...s };
    });

    function topBy(key){
      const sorted = [...asRows].sort((a,b)=>b[key]-a[key]);
      return sorted[0] || null;
    }

    const topGames = topBy('games');
    const topWins = topBy('wins');
    const topGoals = topBy('goals');

    const monthName = now.toLocaleString('de-CH', { month:'long', year:'numeric' });
    box.innerHTML = `
      <div><strong>${monthName}</strong></div>
      <ul>
        <li>Meiste Spiele: <strong>${topGames ? topGames.name : '-'}</strong> (${topGames ? topGames.games : 0})</li>
        <li>Meiste Siege: <strong>${topWins ? topWins.name : '-'}</strong> (${topWins ? topWins.wins : 0})</li>
        <li>Meiste Tore: <strong>${topGoals ? topGoals.name : '-'}</strong> (${topGoals ? topGoals.goals : 0})</li>
      </ul>
      <div class="muted">Hinweis: Monatswerte basieren auf allen eingetragenen Spielen dieses Monats.</div>
    `;
  }

  async function enableRealtime(){
    sb.channel('players-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'players' }, payload => loadPlayers())
      .subscribe();
  }

  (async function init(){
    await loadPlayers();
    await loadMonthStats();
    await enableRealtime();
    setStatus("Bereit.");
  })();
</script>
</body>
</html>
