<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Töggeli Rangliste</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background:#f6f7f9; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border-radius: 14px; padding: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.06); margin-bottom: 14px; }
    h1 { font-size: 18px; margin: 0 0 10px; }
    .muted { color:#666; font-size: 12px; }

    label { font-size: 12px; color:#444; display:block; margin-bottom: 4px; }
    input {
      width: 100%; padding: 12px; border:1px solid #ddd;
      border-radius: 10px; font-size: 16px; box-sizing: border-box;
    }
    button {
      width:100%; padding: 12px; border:0; border-radius: 10px;
      font-size: 16px; background:#111; color:#fff; cursor:pointer;
    }
    button:disabled { opacity: .5; cursor:not-allowed; }

    .grid { display: grid; gap: 10px; }
    @media (min-width: 900px){ .grid-2 { grid-template-columns: 1fr 1fr; } }

    .row { display:flex; gap:10px; align-items: flex-start; }
    .row > div { flex: 1; }

    table { width:100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom:1px solid #eee; text-align:left; font-size: 14px; }
    th { cursor: pointer; user-select:none; white-space:nowrap; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#f1f1f1; font-size:12px; }

    .suggest { position:relative; }
    .suggest-list {
      position:absolute; left:0; right:0; top: 74px;
      background:#fff; border:1px solid #ddd; border-radius: 10px;
      max-height: 220px; overflow:auto; z-index: 9;
    }
    .suggest-item { padding: 10px; border-bottom:1px solid #eee; }
    .suggest-item:last-child { border-bottom:0; }
    .suggest-item:hover { background:#f3f4f6; cursor:pointer; }
  </style>
</head>

<body>
<div class="wrap">

  <!-- NEUER SPIELER -->
  <div class="card">
    <h1>Neuen Spieler anmelden</h1>
    <div class="row">
      <div>
        <label>Spielername</label>
        <input id="newPlayerName" placeholder="z. B. Daniel" autocomplete="off" />
        <div class="muted" style="margin-top:6px">
          Jeder Spieler existiert nur einmal (Gross-/Kleinschreibung egal).
        </div>
      </div>
      <div style="align-self:end">
        <button id="addPlayerBtn">Spieler hinzufügen</button>
      </div>
    </div>
    <div class="muted" id="addPlayerStatus" style="margin-top:8px"></div>
  </div>

  <!-- SPIEL EINTRAGEN -->
  <div class="card">
    <h1>Spiel eintragen (2 vs. 2)</h1>

    <div class="grid grid-2">
      <div>
        <div class="row">
          <div class="suggest">
            <label>Team 1 – Spieler A</label>
            <input id="p1" placeholder="Name tippen…" autocomplete="off" />
            <div class="suggest-list" id="p1_s" style="display:none"></div>
          </div>
          <div class="suggest">
            <label>Team 1 – Spieler B</label>
            <input id="p2" placeholder="Name tippen…" autocomplete="off" />
            <div class="suggest-list" id="p2_s" style="display:none"></div>
          </div>
        </div>
      </div>

      <div>
        <div class="row">
          <div class="suggest">
            <label>Team 2 – Spieler C</label>
            <input id="p3" placeholder="Name tippen…" autocomplete="off" />
            <div class="suggest-list" id="p3_s" style="display:none"></div>
          </div>
          <div class="suggest">
            <label>Team 2 – Spieler D</label>
            <input id="p4" placeholder="Name tippen…" autocomplete="off" />
            <div class="suggest-list" id="p4_s" style="display:none"></div>
          </div>
        </div>
      </div>
    </div>

    <div style="height:10px"></div>

    <div class="row">
      <div>
        <label>Resultat Team 1</label>
        <input id="g1" type="number" min="0" placeholder="z. B. 10" />
      </div>
      <div>
        <label>Resultat Team 2</label>
        <input id="g2" type="number" min="0" placeholder="z. B. 7" />
      </div>
    </div>

    <div style="height:10px"></div>
    <button id="submit">Spiel speichern</button>
    <div class="muted" id="status" style="margin-top:8px"></div>
  </div>

  <!-- RANGLISTE -->
  <div class="card">
    <h1>Live-Rangliste</h1>
    <div class="muted">Tippe auf Spaltenköpfe zum Sortieren.</div>
    <div style="overflow:auto; margin-top:10px">
      <table id="tbl">
        <thead>
          <tr>
            <th data-k="name">Name</th>
            <th data-k="games">Spiele</th>
            <th data-k="wins">Siege</th>
            <th data-k="win_pct">Siege %</th>
            <th data-k="goals_for">Tore</th>
            <th data-k="goals_against">Gegentore</th>
            <th data-k="elo">ELO</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- MONAT -->
  <div class="card">
    <h1>Monatsrückblick</h1>
    <div id="monthStats" class="muted"></div>
  </div>

</div>

<script>
  // SUPABASE (fix & fertig)
  const SUPABASE_URL = "https://upiezncrabetmffxhloq.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwaWV6bmNyYWJldG1mZnhobG9xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNzAxMjAsImV4cCI6MjA4NTk0NjEyMH0.CVYIaX9nF15uXjFsWvysBNW56eKaex9dk4Vot-1hDLY";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const els = {
    p1: p1, p2: p2, p3: p3, p4: p4,
    g1: g1, g2: g2,
    submit: submit,
    status: status,
    newPlayerName: newPlayerName,
    addPlayerBtn: addPlayerBtn,
    addPlayerStatus: addPlayerStatus
  };

  let players = [];
  let sortKey = "elo";
  let sortDir = "desc";

  const norm = s => (s||"").trim();
  const canon = s => norm(s).toLowerCase();

  async function loadPlayers(){
    const { data } = await sb.from("players").select("*");
    players = (data||[]).map(p => ({
      ...p,
      win_pct: p.games ? Math.round((p.wins/p.games)*1000)/10 : 0,
      elo: Math.round(Number(p.elo))
    }));
    renderTable();
  }

  function renderTable(){
    const tbody = document.querySelector("#tbl tbody");
    tbody.innerHTML = "";
    [...players].sort((a,b)=>{
      const d = sortDir==="asc"?1:-1;
      return typeof a[sortKey]==="string"
        ? a[sortKey].localeCompare(b[sortKey])*d
        : (a[sortKey]-b[sortKey])*d;
    }).forEach(p=>{
      tbody.innerHTML += `
        <tr>
          <td>${p.name}</td>
          <td>${p.games}</td>
          <td>${p.wins}</td>
          <td>${p.win_pct}%</td>
          <td>${p.goals_for}</td>
          <td>${p.goals_against}</td>
          <td><span class="pill">${p.elo}</span></td>
        </tr>`;
    });
  }

  document.querySelectorAll("th").forEach(th=>{
    th.onclick = ()=>{
      const k = th.dataset.k;
      if(!k) return;
      sortDir = sortKey===k && sortDir==="desc" ? "asc":"desc";
      sortKey = k;
      renderTable();
    };
  });

  async function addPlayer(){
    try{
      els.addPlayerBtn.disabled = true;
      const name = norm(els.newPlayerName.value);
      if(!name) throw "Name fehlt";
      if(players.some(p=>canon(p.name)===canon(name))) throw "Spieler existiert bereits";
      await sb.from("players").insert({ name });
      els.newPlayerName.value="";
      els.addPlayerStatus.textContent="✅ Spieler hinzugefügt";
      await loadPlayers();
    }catch(e){
      els.addPlayerStatus.textContent="❌ "+e;
    }finally{
      els.addPlayerBtn.disabled=false;
    }
  }
  els.addPlayerBtn.onclick = addPlayer;

  async function submitMatch(){
    try{
      els.submit.disabled=true;
      const names=[p1.value,p2.value,p3.value,p4.value].map(norm);
      if(new Set(names.map(canon)).size!==4) throw "Spieler doppelt";
      const ids=[];
      for(const n of names){
        let p=players.find(x=>canon(x.name)===canon(n));
        if(!p){
          const r=await sb.from("players").insert({name:n}).select().single();
          p=r.data;
          players.push(p);
        }
        ids.push(p.id);
      }
      await sb.from("matches").insert({
        p1_id:ids[0],p2_id:ids[1],p3_id:ids[2],p4_id:ids[3],
        team1_goals:+g1.value, team2_goals:+g2.value
      });
      g1.value=""; g2.value="";
      status.textContent="✅ Spiel gespeichert";
      await loadPlayers();
    }catch(e){
      status.textContent="❌ "+e;
    }finally{
      els.submit.disabled=false;
    }
  }
  submit.onclick = submitMatch;

  loadPlayers();
</script>
</body>
</html>
