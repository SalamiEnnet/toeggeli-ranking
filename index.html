<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Töggeli Rangliste</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background:#f6f7f9; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border-radius: 14px; padding: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.06); margin-bottom: 14px; }
    h1 { font-size: 18px; margin: 0 0 10px; }
    .grid { display: grid; gap: 10px; }
    @media (min-width: 900px){ .grid-2 { grid-template-columns: 1fr 1fr; } }
    label { font-size: 12px; color:#444; display:block; margin-bottom: 4px; }
    input { width: 100%; padding: 12px; border:1px solid #ddd; border-radius: 10px; font-size: 16px; }
    button { width:100%; padding: 12px; border:0; border-radius: 10px; font-size: 16px; background:#111; color:#fff; cursor:pointer; }
    button:disabled { opacity: .5; cursor:not-allowed; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom:1px solid #eee; text-align:left; font-size: 14px; }
    th { cursor: pointer; user-select:none; white-space:nowrap; }
    .muted { color:#666; font-size: 12px; }
    .row { display:flex; gap:10px; }
    .row > div { flex: 1; }
    .suggest { position:relative; }
    .suggest-list { position:absolute; left:0; right:0; top: 74px; background:#fff; border:1px solid #ddd; border-radius: 10px; max-height: 220px; overflow:auto; z-index: 9; }
    .suggest-item { padding: 10px; border-bottom:1px solid #eee; }
    .suggest-item:last-child { border-bottom:0; }
    .suggest-item:hover { background:#f3f4f6; cursor:pointer; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#f1f1f1; font-size:12px; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Spiel eintragen (2 vs. 2)</h1>
    <div class="grid grid-2">
      <div>
        <div class="row">
          <div class="suggest">
            <label>Team 1 – Spieler A</label>
            <input id="p1" placeholder="Name tippen…" autocomplete="off" />
            <div class="suggest-list" id="p1_s" style="display:none"></div>
          </div>
          <div class="suggest">
            <label>Team 1 – Spieler B</label>
            <input id="p2" placeholder="Name tippen…" autocomplete="off" />
            <div class="suggest-list" id="p2_s" style="display:none"></div>
          </div>
        </div>
      </div>
      <div>
        <div class="row">
          <div class="suggest">
            <label>Team 2 – Spieler C</label>
            <input id="p3" placeholder="Name tippen…" autocomplete="off" />
            <div class="suggest-list" id="p3_s" style="display:none"></div>
          </div>
          <div class="suggest">
            <label>Team 2 – Spieler D</label>
            <input id="p4" placeholder="Name tippen…" autocomplete="off" />
            <div class="suggest-list" id="p4_s" style="display:none"></div>
          </div>
        </div>
      </div>
    </div>

    <div style="height:10px"></div>

    <div class="row">
      <div>
        <label>Resultat Team 1</label>
        <input id="g1" type="number" min="0" placeholder="z. B. 10" />
      </div>
      <div>
        <label>Resultat Team 2</label>
        <input id="g2" type="number" min="0" placeholder="z. B. 7" />
      </div>
    </div>

    <div style="height:10px"></div>
    <button id="submit">Spiel speichern</button>
    <div class="muted" id="status" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <h1>Live-Rangliste</h1>
    <div class="muted">Tippe auf Spaltenköpfe zum Sortieren.</div>
    <div style="overflow:auto; margin-top:10px">
      <table id="tbl">
        <thead>
          <tr>
            <th data-k="name">Name</th>
            <th data-k="games">Spiele</th>
            <th data-k="wins">Gewonnen</th>
            <th data-k="win_pct">Gewonnen %</th>
            <th data-k="goals_for">Tore</th>
            <th data-k="goals_against">Gegentore</th>
            <th data-k="elo">ELO</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h1>Monatsrückblick (aktueller Monat)</h1>
    <div class="muted">Unabhängig vom Gesamt-ELO – nur Spiele im aktuellen Monat.</div>
    <div id="monthStats" style="margin-top:10px"></div>
  </div>
</div>

<script>
  const SUPABASE_URL = "https://upiezncrabetmffxhloq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwaWV6bmNyYWJldG1mZnhobG9xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNzAxMjAsImV4cCI6MjA4NTk0NjEyMH0.CVYIaX9nF15uXjFsWvysBNW56eKaex9dk4Vot-1hDLY";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const els = {
    p1: document.getElementById('p1'), p2: document.getElementById('p2'),
    p3: document.getElementById('p3'), p4: document.getElementById('p4'),
    g1: document.getElementById('g1'), g2: document.getElementById('g2'),
    submit: document.getElementById('submit'),
    status: document.getElementById('status'),
  };

  let players = [];
  let sortKey = 'elo';
  let sortDir = 'desc';

  function normName(s){ return (s || '').trim(); }
  function canon(s){ return normName(s).toLowerCase(); }
  function setStatus(msg){ els.status.textContent = msg || ''; }

  async function loadPlayers(){
    const { data, error } = await sb.from('players').select('*');
    if (error) { setStatus("Fehler beim Laden der Spieler: " + error.message); return; }
    players = (data || []).map(p => ({
      ...p,
      win_pct: p.games > 0 ? Math.round((p.wins / p.games) * 1000) / 10 : 0,
      elo: Math.round(Number(p.elo) * 10) / 10
    }));
    renderTable();
  }

  function sortPlayers(list){
    const dir = sortDir === 'asc' ? 1 : -1;
    return [...list].sort((a,b)=>{
      const va = a[sortKey], vb = b[sortKey];
      if (typeof va === 'string') return va.localeCompare(vb) * dir;
      return (Number(va) - Number(vb)) * dir;
    });
  }

  function renderTable(){
    const tbody = document.querySelector('#tbl tbody');
    tbody.innerHTML = '';
    const rows = sortPlayers(players);
    for (const p of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.name}</td>
        <td>${p.games}</td>
        <td>${p.wins}</td>
        <td>${p.win_pct}%</td>
        <td>${p.goals_for}</td>
        <td>${p.goals_against}</td>
        <td><span class="pill">${p.elo}</span></td>
      `;
      tbody.appendChild(tr);
    }
  }

  function attachSuggest(inputEl, listEl){
    inputEl.addEventListener('input', ()=>{
      const q = canon(inputEl.value);
      if (!q){ listEl.style.display='none'; listEl.innerHTML=''; return; }
      const matches = players.filter(p => canon(p.name).includes(q)).slice(0, 8);
      listEl.innerHTML = '';
      for (const m of matches){
        const div = document.createElement('div');
        div.className = 'suggest-item';
        div.textContent = m.name;
        div.onclick = ()=>{ inputEl.value = m.name; listEl.style.display='none'; };
        listEl.appendChild(div);
      }
      listEl.style.display = matches.length ? 'block' : 'none';
    });
    inputEl.addEventListener('blur', ()=> setTimeout(()=>{ listEl.style.display='none'; }, 150));
    inputEl.addEventListener('focus', ()=> inputEl.dispatchEvent(new Event('input')));
  }

  attachSuggest(els.p1, document.getElementById('p1_s'));
  attachSuggest(els.p2, document.getElementById('p2_s'));
  attachSuggest(els.p3, document.getElementById('p3_s'));
  attachSuggest(els.p4, document.getElementById('p4_s'));

  async function getOrCreatePlayerId(name){
    const clean = normName(name);
    if (!clean) throw new Error("Leerer Name");
    const existing = players.find(p => canon(p.name) === canon(clean));
    if (existing) return existing.id;

    const { data, error } = await sb.from('players').insert([{ name: clean }]).select().single();
    if (error){
      await loadPlayers();
      const ex2 = players.find(p => canon(p.name) === canon(clean));
      if (ex2) return ex2.id;
      throw error;
    }
    await loadPlayers();
    return data.id;
  }

  async function submitMatch(){
    try{
      els.submit.disabled = true;
      setStatus("Speichern…");

      const names = [els.p1.value, els.p2.value, els.p3.value, els.p4.value].map(normName);
      if (names.some(n => !n)) throw new Error("Bitte alle 4 Spielernamen ausfüllen.");

      const c = names.map(canon);
      if ((new Set(c)).size !== 4) throw new Error("Ein Spieler darf im gleichen Match nicht doppelt vorkommen.");

      const g1 = Number(els.g1.value), g2 = Number(els.g2.value);
      if (!Number.isFinite(g1) || !Number.isFinite(g2) || g1 < 0 || g2 < 0) {
        throw new Error("Bitte ein gültiges Resultat eingeben (>= 0).");
      }

      const [p1_id, p2_id, p3_id, p4_id] = await Promise.all(names.map(getOrCreatePlayerId));

      const { error } = await sb.from('matches').insert([{
        p1_id, p2_id, p3_id, p4_id,
        team1_goals: g1,
        team2_goals: g2
      }]);

      if (error) throw error;

      els.g1.value = ''; els.g2.value = '';
      setStatus("✅ Gespeichert. Rangliste aktualisiert sich gleich.");
      await loadPlayers();
      await loadMonthStats();
    } catch(e){
      setStatus("❌ " + (e.message || String(e)));
    } finally {
      els.submit.disabled = false;
    }
  }

  els.submit.addEventListener('click', submitMatch);

  document.querySelectorAll('#tbl thead th').forEach(th=>{
    th.addEventListener('click', ()=>{
      const k = th.dataset.k;
      if (!k) return;
      if (sortKey === k) sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
      else { sortKey = k; sortDir = (k === 'name') ? 'asc' : 'desc'; }
      renderTable();
    });
  });

  async function loadMonthStats(){
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), 1);
    const end = new Date(now.getFullYear(), now.getMonth() + 1, 1);

    const { data, error } = await sb.from('matches').select('*')
      .gte('created_at', start.toISOString())
      .lt('created_at', end.toISOString());

    const box = document.getElementById('monthStats');
    if (error) { box.textContent = "Fehler: " + error.message; return; }

    const matches = data || [];
    const stat = new Map();

    function add(pid, games, wins, goals){
      const s = stat.get(pid) || { games:0, wins:0, goals:0 };
      s.games += games; s.wins += wins; s.goals += goals;
      stat.set(pid, s);
    }

    for (const m of matches){
      const t1w = m.team1_goals > m.team2_goals ? 1 : 0;
      const t2w = m.team2_goals > m.team1_goals ? 1 : 0;
      add(m.p1_id, 1, t1w, m.team1_goals);
      add(m.p2_id, 1, t1w, m.team1_goals);
      add(m.p3_id, 1, t2w, m.team2_goals);
      add(m.p4_id, 1, t2w, m.team2_goals);
    }

    const asRows = [...stat.entries()].map(([pid, s])=>{
      const p = players.find(x=>x.id===pid);
      return { name: p ? p.name : ("#" + pid), ...s };
    });

    function topBy(key){ return asRows.sort((a,b)=>b[key]-a[key])[0] || null; }

    const topGames = topBy('games');
    const topWins = topBy('wins');
    const topGoals = topBy('goals');

    const monthName = now.toLocaleString('de-CH', { month:'long', year:'numeric' });
    box.innerHTML = `
      <div><strong>${monthName}</strong></div>
      <ul>
        <li>Meiste Spiele: <strong>${topGames ? topGames.name : '-'}</strong> (${topGames ? topGames.games : 0})</li>
        <li>Meiste Siege: <strong>${topWins ? topWins.name : '-'}</strong> (${topWins ? topWins.wins : 0})</li>
        <li>Meiste Tore: <strong>${topGoals ? topGoals.name : '-'}</strong> (${topGoals ? topGoals.goals : 0})</li>
      </ul>
      <div class="muted">Hinweis: Monatswerte basieren auf allen eingetragenen Spielen dieses Monats.</div>
    `;
  }

  async function enableRealtime(){
    sb.channel('players-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'players' }, payload => loadPlayers())
      .subscribe();
  }

  (async function init(){
    await loadPlayers();
    await loadMonthStats();
    await enableRealtime();
    setStatus("Bereit.");
  })();
</script>
</body>
</html>
